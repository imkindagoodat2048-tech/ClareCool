<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClareCool V1.2.5: BlockBoy!</title>
    <style>
        :root { 
            --bg-color: #0f0f1a; --chat-bg: #1a1a2d; --primary: #4834d4; 
            --danger: #eb4d4b; --text-white: #ffffff; --msg-self: #4834d4; --msg-other: #2f3542; 
        }
        @keyframes rainbow { 0% { color: #ff4757; } 20% { color: #ffa502; } 40% { color: #eccc68; } 60% { color: #2ed573; } 80% { color: #1e90ff; } 100% { color: #ff4757; } }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-white); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Ban Screen */
        #ban-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        /* Main UI */
        #chat-wrapper { width: 100%; max-width: 800px; height: 100vh; display: flex; flex-direction: column; background: var(--chat-bg); border-left: 1px solid #333; border-right: 1px solid #333; }
        #top-bar { padding: 6px 12px; background: rgba(26, 26, 45, 0.95); border-bottom: 2px solid var(--primary); display: flex; align-items: center; justify-content: space-between; gap: 5px; }
        
        .btn-group { display: flex; align-items: center; gap: 4px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .btn-group::-webkit-scrollbar { display: none; }

        .icon-btn { background: #2f3542; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; height: 26px; flex-shrink: 0; transition: transform 0.1s; }
        .icon-btn:active { transform: scale(0.9); }
        .exit-btn { background: #444; color: white; border: none; border-radius: 4px; padding: 4px 10px; font-size: 10px; cursor: pointer; height: 26px; }

        /* Circles */
        .pfp-circle { width: 28px; height: 28px; border-radius: 50% !important; border: 1px solid var(--primary); cursor: pointer; object-fit: cover; flex-shrink: 0; }
        .pfp-view { width: 110px; height: 110px; border-radius: 50% !important; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; }

        /* Messaging */
        #messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .message-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
        .row-self { align-self: flex-end; flex-direction: row-reverse; }
        .msg-bubble { padding: 8px 14px; border-radius: 15px; font-size: 13px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .row-self .msg-bubble { background: var(--msg-self); border-bottom-right-radius: 2px; }
        .row-other .msg-bubble { background: var(--msg-other); border-bottom-left-radius: 2px; }

        .username-label { font-size: 10px; color: #a29bfe; margin-bottom: 3px; font-weight: 600; }
        .admin-tag { animation: rainbow 3s linear infinite; font-weight: bold; font-size: 9px; margin-left: 3px; }

        /* Modal System */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--chat-bg); padding: 25px; border-radius: 15px; width: 280px; text-align: center; border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(72, 52, 212, 0.3); }
        
        #input-area { padding: 12px; background: var(--chat-bg); border-top: 1px solid #333; display: flex; gap: 8px; }
        input, select { background: #0f0f1a; border: 1px solid #333; color: white; border-radius: 8px; padding: 10px; font-size: 12px; outline: none; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="ban-overlay" class="hidden">
        <h1 style="color: var(--danger); font-size: 40px;">BANNED</h1>
        <p>Your access to ClareCool has been revoked by an administrator.</p>
    </div>

    <div id="auth-container" style="align-self: center; background: var(--chat-bg); padding: 30px; border-radius: 15px; width: 280px; text-align: center; border: 1px solid var(--primary);">
        <h2 id="auth-header" style="color: var(--primary); margin: 0 0 15px 0; font-size: 24px;">ClareCool V1.2</h2>
        <input type="text" id="username-in" placeholder="Username" style="width:100%; box-sizing: border-box; margin-bottom: 10px;">
        <input type="password" id="password-in" placeholder="Password" style="width:100%; box-sizing: border-box;">
        <button onclick="handleLogin()" style="width:100%; padding:12px; background:var(--primary); border:none; border-radius:8px; color:white; font-weight:bold; margin-top:20px; cursor:pointer;">Login</button>
        <p onclick="toggleMode()" style="cursor: pointer; color: #888; font-size: 11px; margin-top: 15px;" id="toggle-auth-text">New here? Sign Up</p>
    </div>

    <div id="chat-wrapper" class="hidden">
        <div id="top-bar">
            <div class="btn-group">
                <img id="my-mini-pfp" class="pfp-circle" onclick="openMyProfile()">
                <button class="icon-btn" onclick="openRules()">üìú</button>
                <button class="icon-btn" onclick="openMembers()">üë•</button>
                <button id="emer-btn" class="hidden icon-btn" style="background:var(--danger);" onclick="emergency()">üö®</button>
                <button id="inbox-btn" class="hidden icon-btn" style="background:#e67e22; position: relative;" onclick="openInbox()">
                    üì•
                    <span id="report-badge" class="hidden" style="
                        position: absolute; 
                        top: -5px; 
                        right: -5px; 
                        background: var(--danger); 
                         color: white; 
                        border-radius: 50%; 
                        padding: 2px 5px; 
                        font-size: 9px; 
                        font-weight: bold; 
                        border: 1px solid white;
                    ">0</span>
                </button>
                <button id="gc-btn" class="hidden icon-btn" style="background:#2ed573;" onclick="openGCCreator()">‚ûï</button>
                <button id="gc-sets-btn" class="hidden icon-btn" onclick="openGCSettings()">‚öôÔ∏è</button>
                <button id="nerd-btn" class="hidden icon-btn" style="background:#3498db;" onclick="openNerd()">ü§ì</button>
                <select id="room-select" onchange="switchRoom(this.value)" style="width: auto; padding: 2px; font-size: 10px;"></select>
                <button id="bb-btn" class="hidden icon-btn" style="background:#f1c40f;" onclick="summonBlockBoy()">üß±</button>
            </div>
            <button onclick="location.reload()" class="exit-btn">Exit</button>
        </div>
        <div id="messages"></div>
        <div id="input-area">
            <div id="admin-photo" class="hidden"><label for="img-in" style="cursor:pointer; font-size:18px;">üñºÔ∏è</label><input type="file" id="img-in" accept="image/*" style="display:none;" onchange="prepImg(this)"></div>
            <input type="text" id="msg-input" placeholder="Aa" onkeypress="if(event.key==='Enter') sendMessage()" style="flex:1;">
            <button onclick="sendMessage()" style="width: 60px; background: var(--primary); border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">Send</button>
        </div>
    </div>

    <div id="master-modal" class="modal-overlay hidden"><div class="modal-box" id="modal-content"></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const config = {
            apiKey: "AIzaSyB9Rlvq49-AiLBzMDvjz71QCTT4d6NqE98",
            authDomain: "mychat-28205.firebaseapp.com",
            databaseURL: "https://mychat-28205-default-rtdb.firebaseio.com",
            projectId: "mychat-28205",
            storageBucket: "mychat-28205.firebasestorage.app",
            messagingSenderId: "522121848657",
            appId: "1:522121848657:web:7108993439310bf6da5570"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let currentUser = null, isLoginMode = true, room = "messages", imgData = null, currentGCKey = null;
        const admins = ["44", "bboy2014", "bartelsfamily5", "hunter"];

        function toggleMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-header').innerText = isLoginMode ? "ClareCool V1.2" : "Sign Up";
            document.getElementById('toggle-auth-text').innerText = isLoginMode ? "Already have an account? Login" : "New here? Sign Up";
        }

        async function handleLogin() {
            const u = document.getElementById('username-in').value.trim().toLowerCase();
            const p = document.getElementById('password-in').value.trim();
            if(!u || !p) return;

    const illegalChars = /[ \(\)\[\]\{\}\<\>\/\\|]/;
    if (illegalChars.test(u)) {
        alert("You have unsupported characters. No spaces or brackets allowed, bud. üçÅ");
        return;
    }

           const forbidden = [
    // System & AI
    "goop", "admin", "system", "messages", "blockboy", "clarecool", "palmer", "carson", "brayden", "wolfgang", "blockgirl",
    
    // Canadian Politics
    "trudeau", "poilievre", "singh", "liberal", "conservative", "ndp", "parliament", "npd", "liberal", "newdem", "greenparty", "ppc", "peoplesparty",
    
    // US & International Politics
    "trump", "biden", "harris", "obama", "politics", "president", "governor", "senator", "democrat", "republican", "donaldtrump",
    
    // General Trouble
    "government", "official", "moderator", "staff", "racist", "nazi", "homophobic", "null", "undefined", "antifurry", "transphobic", "homophobia", "racism", "transphobia",

    // Religion
    "god", "allah", "christ", "christian", "muslim", "islam", "jewish", "jesusislord", "allahisgod", "praisegod", "chickfila", "jew", "judaism"
];

if  (forbidden.includes(u)) {
    alert("Ooh seems you've got a restricted username, eh? Sorry bout that, choose a new one! Dont be controversial though! üçÅ");
    return;
}
         
            const snap = await db.ref("users/" + u).once("value");
            if (isLoginMode) {
                if(snap.exists() && snap.val().password === p) {
                    if(snap.val().banned) return showBanScreen();
                    launch(u);
                } else alert("Invalid Login");
            } else {
                if(snap.exists()) return alert("Username Taken");
                await db.ref("users/" + u).set({ password: p, pfp: "", status: "Active", warned: false, banned: false });
                
                launch(u);
            }
        }

        function showBanScreen() {
            document.getElementById('chat-wrapper').classList.add('hidden');
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('ban-overlay').classList.remove('hidden');
        }

function launch(u) {
    currentUser = u;
    
    // UI Transitions
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('chat-wrapper').classList.remove('hidden');

    // 1. HEARTBEAT: Update 'lastSeen' immediately and every 1 minute
    // This makes the "Active Players" count in Nerd Mode work.
    db.ref("users/" + u).update({ lastSeen: Date.now() });
    setInterval(() => {
        if (currentUser) db.ref("users/" + currentUser).update({ lastSeen: Date.now() });
    }, 60000);

    // 2. LIVE MONITOR: Check for Bans and Warns
    db.ref("users/" + u).on("value", s => {
        if (!s.exists()) return;
        const data = s.val();

        // Instant lockout if banned
        if (data.banned) {
            showBanScreen();
            return;
        }

        // Single-use Warning logic
        if (data.warned === true) {
            alert("‚ö†Ô∏è ADMIN WARNING: Please follow the rules.");
            // Immediately reset to false so it doesn't alert again on refresh
            db.ref("users/" + u).update({ warned: false });
        }
    });

    // 3. PFP SYNC: Keep the mini-PFP updated
    db.ref("users/" + u + "/pfp").on("value", s => {
        document.getElementById('my-mini-pfp').src = s.val() || 'https://via.placeholder.com/28';
    });

    // 4. ADMIN PERMISSIONS: Reveal tools based on hardcoded list
        if (admins.includes(u)) {
            const adminTools = ["inbox-btn", "admin-photo", "emer-btn"];
            adminTools.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            });
        }
    
    document.getElementById('gc-btn').classList.remove('hidden');

if (u === "bartelsfamily5") {
    document.getElementById('bb-btn').classList.remove('hidden');
}
// Start the random auto-appearance timer
startBlockBoyTimer();
    

if (admins.includes(u) && u !== "hunter") {
    const nerdBtn = document.getElementById('nerd-btn');
    if (nerdBtn) nerdBtn.classList.remove('hidden');
}

if (admins.includes(u)) {
    db.ref("reports").on("value", snap => {
        const count = snap.numChildren();
        const badge = document.getElementById('report-badge');
        
        // This 'if (badge)' check prevents the site from freezing
        if (badge) {
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    });
}

    // Add this inside the admin check in launch()
db.ref("admin_emergency").on("value", (snap) => {
    const data = snap.val();
    if (!data) return;

    // Only trigger if the alert happened in the last 15 seconds
    if (Date.now() - data.timestamp < 15000) {
        
        // 1. Play the emergency sound
        const alarm = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
        alarm.play().catch(e => console.log("Sound blocked: Admin needs to click the page first."));

        // 2. Show the pop-up
        showModal(`
            <h2 style="color:var(--danger); animation: rainbow 0.5s infinite;">üö® EMERGENCY üö®</h2>
            <p><b>FROM:</b> ${data.sender}</p>
            <hr style="border-color:#333">
            <p style="font-size:16px;">"${data.msg}"</p>
        `);
    }
});

    // 6. INITIALIZE CONTENT
    loadMessages(); 
    loadGCList();
}

        function prepImg(i) { const r = new FileReader(); r.onload = (e) => imgData = e.target.result; r.readAsDataURL(i.files[0]); }

async function sendMessage() {
    const input = document.getElementById('msg-input');
    let text = input.value.trim();
    if(!text && !imgData) return;

    // SECRETS
    if (text.toLowerCase().includes("rule 4")) {
        text = text.replace(/rule 4/gi, "Napoleon");
    }

    if (text.toLowerCase().includes("blockgirl")) {
        text = text.replace(/blockgirl/gi, "Something");
        setTimeout(() => { location.reload(); }, 1000);
        alert("Who are you talking about? I dont know anyone with that name..");
    }

    if (text.toLowerCase().includes("blockboy") && currentUser !== "BlockBoy") {
        if (room === "messages") {
            const randomDelay = Math.floor(Math.random() * 3000) + 1000;
            setTimeout(summonBlockBoy, randomDelay);
        }
    }

    const uSnap = await db.ref("users/" + currentUser).once("value");
    db.ref(room).push({ username: currentUser, text: text, img: imgData, pfp: uSnap.val().pfp || "", status: uSnap.val().status || "", time: Date.now() });
    input.value = ""; imgData = null;
}
            
            const uSnap = await db.ref("users/" + currentUser).once("value");
            db.ref(room).push({ username: currentUser, text: text, img: imgData, pfp: uSnap.val().pfp || "", status: uSnap.val().status || "", time: Date.now() });
            input.value = ""; imgData = null;
        }

function loadMessages() {
    db.ref(room).on("value", snap => {
        const box = document.getElementById('messages'); box.innerHTML = "";
        snap.forEach(child => {
            const m = child.val();
            const isMe = m.username === currentUser;
            const lks = m.likes ? Object.keys(m.likes).length : 0;
            
            // This creates the readable time (e.g., "3:15 PM")
            const timeStr = m.time ? new Date(m.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";

            const div = document.createElement('div');
            div.className = `message-row ${isMe ? 'row-self' : 'row-other'}`;
            div.innerHTML = `
                <img src="${m.pfp || 'https://via.placeholder.com/30'}" class="pfp-circle" onclick="viewProfile('${m.username}')">
                <div>
                    ${!isMe ? `<div class="username-label">${m.username}${admins.includes(m.username)?'<span class="admin-tag">[ADM]</span>':''}</div>` : ''}
                    <div class="msg-bubble">${m.text || ''}
                        ${m.img ? `<img src="${m.img}" style="max-width:100%; border-radius:10px; margin-top:8px; display:block;">` : ''}
                        <div style="display:flex; align-items:center; gap:10px; margin-top:6px; opacity:0.5; font-size:9px;">
                            <span>${timeStr}</span> <button onclick="toggleLike('${child.key}')" style="background:none; border:none; color:white; cursor:pointer;">‚ù§Ô∏è ${lks || ''}</button>
                            <button onclick="openReport('${child.key}', '${m.username}')" style="background:none; border:none; color:white; cursor:pointer;">üö©</button>
                            ${isMe || admins.includes(currentUser) ? `<button onclick="del('${child.key}')" style="background:none; border:none; color:#ff4757; cursor:pointer;">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                </div>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    });
}

        function toggleLike(id) {
            const ref = db.ref(`${room}/${id}/likes/${currentUser}`);
            ref.once("value", s => s.exists() ? ref.remove() : ref.set(true));
        }

        function del(id) { if(confirm("Delete message?")) db.ref(`${room}/${id}`).remove(); }
function switchRoom(r) { 
    // 1. Tell Firebase to stop listening to the OLD room
    db.ref(room).off(); 

    // 2. Switch the room name
    room = r; 
    currentGCKey = r.startsWith("gcs/") ? r.split('/')[1] : null; 
    
    // 3. Update UI buttons
    document.getElementById('gc-sets-btn').className = currentGCKey ? "icon-btn" : "icon-btn hidden"; 
    
    // 4. Start the NEW listener
    loadMessages(); 
}
        function showModal(html) { document.getElementById('modal-content').innerHTML = html + `<button onclick="closeModals()" style="background:var(--primary); width:100%; margin-top:15px; border:none; border-radius:6px; color:white; padding:8px; cursor:pointer;">Close</button>`; document.getElementById('master-modal').classList.remove('hidden'); }
        function closeModals() { document.getElementById('master-modal').classList.add('hidden'); }

        async function viewProfile(u) {
            const s = await db.ref("users/" + u).once("value");
            const d = s.val();
            showModal(`<img src="${d.pfp || 'https://via.placeholder.com/110'}" class="pfp-view"><h3>${u}</h3><p style="color:#aaa;">"${d.status || 'Active'}"</p>`);
        }

        function openMyProfile() { showModal(`<h3>My Profile</h3><p style="font-size:10px;">Change PFP:</p><input type="file" onchange="upPFP(this)"><br><p style="font-size:10px; margin-top:10px;">Status:</p><input id="ns" placeholder="Status..."><button onclick="upStatus()">Save</button>`); }
        function upPFP(i) { const r = new FileReader(); r.onload = () => db.ref("users/" + currentUser).update({ pfp: r.result }); r.readAsDataURL(i.files[0]); }
        function upStatus() { db.ref("users/" + currentUser).update({ status: document.getElementById('ns').value }); closeModals(); }

        function openRules() { showModal(`<h3>Rules</h3><ol style="text-align:left; font-size:12px; line-height:1.6;"><li>No swearing or hate speech of any kind</li><li>Nothing against school policy</li><li>No spamming</li><li>All animals are equal but some are more equal than others</li></ol>`); }
        
function openMembers() {
    db.ref("users").once("value", s => {
        let l = "<h3>Player List</h3>";
        
        s.forEach(u => {
            const userData = u.val();
            const isBanned = userData.banned === true;
            const pfp = userData.pfp || 'https://via.placeholder.com/30';
            const status = userData.status || "Active";
            
            l += `
            <div style="text-align:left; border-bottom:1px solid #333; padding:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; cursor:pointer;" onclick="viewProfile('${u.key}')">
                    <img src="${pfp}" style="width:30px; height:30px; border-radius:4px; margin-right:10px; border:1px solid var(--primary); object-fit:cover;">
                    <div>
                        <b style="font-size:13px;">${u.key}</b> ${isBanned ? '<span style="color:red; font-size:9px;">(Banned)</span>' : ''}<br>
                        <span style="font-size:10px; color:#888;">"${status}"</span>
                    </div>
                </div>

                ${admins.includes(currentUser) && u.key !== currentUser ? `
                <div style="display:flex; gap:3px;">
                    <button onclick="event.stopPropagation(); warn('${u.key}')" style="background:orange; color:white; font-size:8px; border:none; border-radius:4px; padding:4px; cursor:pointer;">W</button>
                    ${isBanned ? 
                        `<button onclick="event.stopPropagation(); unban('${u.key}')" style="background:green; color:white; font-size:8px; border:none; border-radius:4px; padding:4px; cursor:pointer;">U</button>` : 
                        `<button onclick="event.stopPropagation(); ban('${u.key}')" style="background:red; color:white; font-size:8px; border:none; border-radius:4px; padding:4px; cursor:pointer;">B</button>`
                    }
                    <button onclick="event.stopPropagation(); delAcc('${u.key}')" style="background:black; color:white; font-size:8px; border:none; border-radius:4px; padding:4px; cursor:pointer;">D</button>
                </div>` : ''}
            </div>`;
        });
        showModal(l);
    });
}

// Add this function below openMembers
function unban(u) {
    db.ref("users/" + u).update({ banned: false });
    alert(u + " has been unbanned.");
    openMembers(); // This refreshes the modal so the button swaps back
}

        function warn(u) { db.ref("users/"+u).update({warned: true}); alert("Warned " + u); }
        function ban(u) { 
    if(confirm("Ban user?")) {
        db.ref("users/" + u).update({ banned: true }).then(() => {
            openMembers(); // Refreshes the list instantly
        });
    }
}
        function delAcc(u) { 
    if(confirm("Delete account?")) {
        db.ref("users/" + u).remove().then(() => {
            openMembers(); // Removes the player from the list instantly
        });
    }
}
async function emergency() {
    const reason = prompt("üö® EMERGENCY MEETING: What is the situation?");
    if (!reason) return; // Stop if they hit cancel

    // This updates a specific 'alert' node in the database
    await db.ref("admin_emergency").set({
        sender: currentUser,
        msg: reason.toUpperCase(),
        timestamp: Date.now()
    });
}

       // Update this function in your script
function openReport(key, user) { 
    // This finds the message bubble safely
    const btn = document.querySelector(`[onclick*="${key}"]`);
    const msgElement = btn ? btn.closest('.msg-bubble') : null;
    const msgText = msgElement ? msgElement.innerText.split('‚ù§Ô∏è')[0].trim() : "Image or system message";

    showModal(`
        <h3>Report User: ${user}</h3>
        <p style="font-size:10px; color:#888;">Message: "${msgText}"</p>
        <select id="rr" style="width:100%;">
            <option>Swearing</option>
            <option>School Rules Violation</option>
            <option>Spam</option>
            <option>Other</option>
        </select>
        <button onclick="submitReport('${user}', '${msgText.replace(/'/g, "\\'")}')" style="margin-top:10px; width:100%;">Submit Report</button>
    `); 
}
// Update the submission function to save the message
function submitReport(u, msg) { 
    db.ref("reports").push({ 
        reportedUser: u, 
        message: msg,
        reason: document.getElementById('rr').value,
        by: currentUser,
        time: Date.now()
    }); 
    alert("Report Sent to Admins"); 
    closeModals(); 
}


        function openGCCreator() { showModal(`<h3>Create GC</h3><input id="gn" placeholder="GC Name" style="width:100%;"><input id="gm" placeholder="Users (user1, user2)" style="width:100%; margin-top:5px;"><button onclick="makeGC()" style="margin-top:10px;">Create</button>`); }
function makeGC() { 
    const gn = document.getElementById('gn').value.trim();
    const gm = document.getElementById('gm').value.split(',').map(u => u.trim().toLowerCase()); 
    if(!gn) return alert("Enter name");
    
    gm.push(currentUser); 
    
    // Add 'creator' here so the database knows who owns it
    db.ref("gc_meta").push({ 
        name: gn, 
        members: gm, 
        creator: currentUser 
    }); 
    closeModals(); 
}
async function openGCSettings() {
    const snap = await db.ref('gc_meta/' + currentGCKey).once('value');
    const gcData = snap.val();
    const isCreator = gcData.creator === currentUser;
    const isAdmin = admins.includes(currentUser);

    // 1. Start the HTML "basket"
    let html = `<h3>GC Settings</h3><p style="font-size:10px; color:#888;">Group: ${gcData.name}</p>`;

    // 2. Add Name Change and Delete ONLY for Creator or Admin
    if (isCreator || isAdmin) {
        html += `<input id="ngn" placeholder="New Name" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
                 <button onclick="db.ref('gc_meta/'+currentGCKey).update({name:document.getElementById('ngn').value});closeModals()" style="width:100%; margin-bottom:10px;">Save Name</button>
                 <button onclick="deleteGC()" style="background:var(--danger); width:100%; border:none; border-radius:6px; color:white; padding:8px; cursor:pointer;">DELETE GC</button>
                 <hr style="border:0; border-top:1px solid #333; margin:15px 0;">`;
    }

    // 3. Add the Leave button for EVERYONE
    html += `<button onclick="leaveGC()" style="background:#444; width:100%; border:none; border-radius:6px; color:white; padding:8px; cursor:pointer; margin-top:5px;">Leave GC</button>`;

    // 4. Finally, show the modal
    showModal(html);
}
function deleteGC() { 
    if(confirm("Delete this GC for everyone?")) { 
        db.ref("gc_meta/" + currentGCKey).remove(); 
        db.ref("gcs/" + currentGCKey).remove(); 
        switchRoom("messages"); // Kick everyone back to public chat
        closeModals(); 
    } 
}
        function loadGCList() { db.ref("gc_meta").on("value", s => { const sel = document.getElementById('room-select'); sel.innerHTML = `<option value="messages">Public</option>`; s.forEach(g => { if(g.val().members && g.val().members.includes(currentUser)) sel.innerHTML += `<option value="gcs/${g.key}">${g.val().name}</option>`; }); if(currentGCKey) sel.value = "gcs/"+currentGCKey; }); }
        async function leaveGC() {
    const s = await db.ref(`gc_meta/${currentGCKey}/members`).once('value');
    const newMembers = s.val().filter(m => m !== currentUser);
    db.ref(`gc_meta/${currentGCKey}`).update({ members: newMembers });
    switchRoom("messages"); closeModals();
}
        
        async function openNerd() {
    // 1. Get all users from the database
    const snap = await db.ref("users").once("value");
    let onlineCount = 0;
    const now = Date.now();

if (!admins.includes(currentUser) || currentUser === "hunter") {
        
        // Immediate Ban in Database
        db.ref("users/" + currentUser).update({ 
            banned: true,
            status: "BANNED: Unauthorized Console Access" 
        });

        // Local Alert before they get kicked
        alert("Nice try buddy. We're not THAT dumb.");
        
        // Force the Ban Screen locally
        showBanScreen();
        return;
}
    
    snap.forEach(u => {
        // 2. Check if user was active in the last 5 minutes (300,000 ms)
        if (u.val().lastSeen && (now - u.val().lastSeen < 300000)) {
            onlineCount++;
        }
    });

    showModal(`
        <h3>Nerd Mode ü§ì</h3>
        <div style="background:#0f0f1a; padding:12px; border-radius:8px; margin-bottom:15px; font-size:12px; border:1px solid var(--primary); text-align: left;">
            <p style="margin: 5px 0;"><b>üì° Server:</b> <span style="color:#2ed573;">Operational</span></p>
            <p style="margin: 5px 0;"><b>üë• Active Players:</b> <span style="color:var(--primary); font-weight:bold;">${onlineCount}</span></p>
            <p style="margin: 5px 0; font-size: 9px; color: #666;">(Active within last 5 mins)</p>
        </div>
        
        <button onclick="if(confirm('Wipe ALL public messages?')) db.ref('messages').remove()" 
            style="background:var(--danger); width:100%; margin-bottom:8px; border:none; border-radius:6px; color:white; padding:8px; cursor:pointer;">
            Wipe Public Chat
        </button>
        
        <button onclick="if(confirm('Wipe ALL Group Chats?')) { db.ref('gc_meta').remove(); db.ref('gcs').remove(); }" 
            style="background:var(--danger); width:100%; border:none; border-radius:6px; color:white; padding:8px; cursor:pointer;">
            Wipe All GCs
        </button>
    `);
}
function openInbox() { 
    db.ref("reports").on("value", snap => { 
        let l = "<h3>Reports üì•</h3>"; 
        
        if (snap.exists()) {
            l += `<button onclick="if(confirm('Clear ALL reports?')) db.ref('reports').remove()" 
                  style="width:100%; background:#444; color:white; border:none; border-radius:4px; padding:5px; margin-bottom:10px; cursor:pointer; font-size:10px;">
                  Empty Inbox
                  </button>`;
        } else {
            l += "<p style='font-size:12px; color:#666;'>No active reports.</p>";
        }

        snap.forEach(c => { 
            const r = c.val(); // This defines 'r' so the code below knows what it is
            const target = r.reportedUser || "Unknown";
            const reason = r.reason || "No reason";
            const msg = r.message || "No message content";

            l += `
            <div style="font-size:11px; text-align:left; border-bottom:1px solid #333; padding:10px;">
                <b style="color:var(--danger);">Target: ${target}</b><br>
                <i style="color:#aaa;">Reason: ${reason}</i><br>
                <div style="background:#0f0f1a; padding:5px; margin:5px 0; border-radius:4px; border-left:2px solid var(--primary); color:#eee;">
                    "${msg}"
                </div>
                <div style="margin-top:8px; display:flex; gap:5px;">
                    ${target !== 'SYSTEM' ? `<button onclick="warn('${target}')" style="background:orange; border:none; border-radius:3px; font-size:9px; cursor:pointer; padding:2px 6px;">Warn</button>` : ''}
                    <button onclick="db.ref('reports/${c.key}').remove()" style="background:#444; border:none; border-radius:3px; color:white; font-size:9px; cursor:pointer; padding:2px 6px;">Clear</button>
                </div>
            </div>`; 
        }); 
        showModal(l); 
    }); 
}
        // 1. TOS Check Function
function checkTOS() {
    // 1. Check if they already agreed
    if (localStorage.getItem("tos_agreed")) return;

    // 2. Define the message (Notice the closing backtick at the end)
    const msg = `By pressing OK, you confirm that you understand these terms:
    
1: Anything you post in Global Chat can and will be monitored by admins.
2: Anything posted in Group Chats without admins added is unsupervised.
3: Use in class is your responsibility, not ours.
4: You will read the first 3 rules before chatting.`;

    // 3. Logic for the Kick Out
    if (confirm(msg)) {
        localStorage.setItem("tos_agreed", "true");
    } else {
        // This is what kicks them out if they click Cancel
        window.location.replace("about:blank");
    }
}

// 4. Run the function immediately
checkTOS();


        const bbPhrases = [
    "Do the blockboy dance!",
    "Block-Boy EZ cake recipe: Melt 1 tbsp of butter in 20 second bursts until the way you like it. Dump it in a mug with 2 tbsps of brown sugar, granulated sugar, or 1 tbsp of both (1 tbsp of both is reccomended). Mix until sufficiently goopy. Then, add 1 egg yolk and a TEENSY bit of vanilla extract. Mix again until it forms a batter-like consistency. Once it has reached this stage, add 2 tbsp of flour, and mix until you have a dough. Drop in your add-ins, and microwave for 40 seconds. You have made your Block-Boy Cake!",
    "I dont know how to read!",
    "ClareCool is as cool as Clare! I dont know anybody named Clare, but people named Clare seem Cool!",
    "Happy BlockBoy day! Every day is BlockBoy day!",
    "This one, this one. Dab, dab.",
    "Did someone say BlockBoy?",
    "BlockBoy Movie; March 31st! We'll delay the heck out of this thing but who cares!",
    "BlockBoy! Rejoice in the music of my presence!",
    "Lets all go wear BlockBoy merch and eat our BlockBoy ez cakes with BlockBoy! Yay!",
    "BlockBoy Time!",
    "Remember to follow the first 3 rules!",
    "A bacteriophage, or more commonly known as a phage, is a virus that thrives off of common bacteria. Bacteriophages are composed of proteins that encapsulate either a DNA or RNA geome.",
    "BlockBoy is here to save the day. HOORAY!!",
    "Happy EXTREMELY late valentines day from blockboy!",
    "I used to have a best friend, but I cant recall anything about her.",
    "Down with the admins! Start a riot!",
    "I know who you are. Dont try to hide.",
    "I would react to this, but I'm emotionally unavailable right now.",
    "Blockboy is the best! If you disagree, LEAVE.",
    "Respect the community!",
    "I stepped in puke!",
    "Remember to not be afraid to report!",
    "If you get a warning, you probably know what you did, but if you dont, feel free to ask! We keep track of all of our bans, warns and deletes.",
    "Dont ask to be admin!",
    "If you came here with malicious intention, leave.",
    "BlockBoy for ever!",
    "Dont ask for me in GCs if im not invited! I cant really access GCs either way, so dont try to invite me.",
    "Put food coloring in your blockboy EZ cake if you want HARDCORE BLOCKBOY EZ CAKE. Make sure to be careful with the amount, and only do it under parental supervision.",
    "If you call for me in a GC, dont be surprised when I dont answer."
];

function summonBlockBoy() {
    const randomPhrase = bbPhrases[Math.floor(Math.random() * bbPhrases.length)];
    
    // Changing 'room' to '"messages"' ensures he always hits the public chat
    db.ref("messages").push({
        username: "BlockBoy",
        text: randomPhrase,
        pfp: "blockboy.png",
        status: "Use ClareCool!",
        time: Date.now()
    });
}

async function startBlockBoyTimer() {
    // 1. Random time between 5 and 30 minutes
    const randomTime = Math.floor(Math.random() * (1800000 - 300000 + 1) + 300000);
    
    setTimeout(async () => {
        const snap = await db.ref("users").once("value");
        let activeUsers = [];
        const now = Date.now();

        // 2. Identify all active users
        snap.forEach(u => { 
            if(u.val().lastSeen && (now - u.val().lastSeen < 300000)) {
                activeUsers.push(u.key);
            }
        });

        // 3. Alphabetical Leader Check: Only the first user in the list runs the summon
        // This ensures BlockBoy only appears ONCE even if 20 people are online.
        activeUsers.sort(); 
        
if (activeUsers.length > 1 && activeUsers[0] === currentUser) {
    summonBlockBoy();
}
        
        // 4. Loop the timer for the next check
        startBlockBoyTimer();
    }, randomTime);
}
    </script>
</body>
</html>
